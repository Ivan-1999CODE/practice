import React, { useState, useEffect, useRef } from 'react';
import { 
  ArrowRight, CheckCircle, RefreshCw, Undo2,
  Lightbulb, Coffee, CloudRain, Image as ImageIcon, 
  BookOpen, Layers, MapPin, User, Activity, Clock, 
  GraduationCap, Play, ToggleLeft, ToggleRight, Sparkles, MousePointer2, Check, XCircle, Info, Star,
  Heart, ShoppingBasket, ShoppingBag, Utensils
} from 'lucide-react';

// ==========================================
// ğŸ’¡ å­å…ƒä»¶ï¼šæˆ°å‰è¨£ç«…å¡ (Tips View)
// ==========================================
const TipsView = ({ onNext }) => {
  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 flex flex-col items-center justify-center animate-fade-in">
      <div className="max-w-3xl w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 flex flex-col">
        
        {/* æ¨™é¡Œå€ */}
        <div className="bg-amber-500 p-6 text-white text-center relative overflow-hidden">
           <div className="absolute top-0 left-0 w-full h-full bg-white/10 transform -skew-y-6 origin-top-left"></div>
           <h2 className="text-2xl font-bold relative z-10 flex items-center justify-center gap-2">
             <Star className="w-6 h-6 fill-current text-yellow-200" /> 
             30ç§’é«˜åˆ†å›ç­”è¨£ç«…
           </h2>
           <p className="opacity-90 mt-2 relative z-10 text-amber-50">åœ¨é–‹å§‹ç·´ç¿’å‰ï¼Œè«‹å…ˆè¨˜ä½é€™ä¸‰æ‹›ï¼</p>
        </div>
        
        {/* å…§å®¹å€ */}
        <div className="p-6 md:p-10 space-y-8">
           {/* Tip 1 */}
           <div className="flex gap-5 items-start group">
             <div className="w-12 h-12 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xl shrink-0 shadow-sm group-hover:scale-110 transition-transform">1</div>
             <div>
               <h3 className="font-bold text-lg text-slate-800 mb-1">ç¬¬ä¸€å¥å…¬å¼ï¼šä¸»è§’ + åœ°é» + æ°›åœ</h3>
               <p className="text-slate-600 leading-relaxed text-sm md:text-base">
                 ä¸è¦åªèªª "I see a girl."ã€‚<br/>
                 è©¦è‘—ä¸€å£æ°£èªªå®Œï¼š "I see <span className="text-blue-600 font-bold">a girl</span> in <span className="text-blue-600 font-bold">a cafe</span> on <span className="text-blue-600 font-bold">a sunny day</span>."
               </p>
             </div>
           </div>

           {/* Tip 2 */}
           <div className="flex gap-5 items-start group">
             <div className="w-12 h-12 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-xl shrink-0 shadow-sm group-hover:scale-110 transition-transform">2</div>
             <div>
               <h3 className="font-bold text-lg text-slate-800 mb-1">è§€å¯Ÿé †åºï¼šç„¦é» â” ç´°ç¯€ â” æƒ³åƒ</h3>
               <p className="text-slate-600 leading-relaxed text-sm md:text-base">
                 å…ˆçœ‹ä¸­é–“çš„äºº <span className="bg-purple-50 text-purple-700 px-1 rounded">åšä»€éº¼</span> (Action)ï¼Œ<br/>
                 å†çœ‹æ—é‚Š <span className="bg-purple-50 text-purple-700 px-1 rounded">æœ‰ä»€éº¼</span> (Detail)ï¼Œ<br/>
                 æœ€å¾ŒåŠ ä¸Š "I imagine..." ä¾†æ¨æ¸¬ <span className="bg-purple-50 text-purple-700 px-1 rounded">é—œä¿‚</span>ã€‚
               </p>
             </div>
           </div>

           {/* Tip 3 */}
           <div className="flex gap-5 items-start group">
             <div className="w-12 h-12 rounded-2xl bg-pink-100 text-pink-600 flex items-center justify-center font-bold text-xl shrink-0 shadow-sm group-hover:scale-110 transition-transform">3</div>
             <div>
               <h3 className="font-bold text-lg text-slate-800 mb-1">æº«é¦¨çµå°¾ï¼šå–„ç”¨å°æ¯” (Contrast)</h3>
               <p className="text-slate-600 leading-relaxed text-sm md:text-base">
                 ç”¨ "Although..." (é›–ç„¶ç’°å¢ƒ...) "But..." (ä½†æ˜¯æ„Ÿè¦º...) ä¾†è£½é€ åå·®ã€‚<br/>
                 ä¾‹å¦‚ï¼šé›–ç„¶å¤–é¢ä¸‹é›¨ï¼Œä½†å¿ƒè£¡å¾ˆæº«æš–ã€‚
               </p>
             </div>
           </div>
        </div>

        {/* æŒ‰éˆ•å€ */}
        <div className="p-6 bg-slate-50 border-t border-slate-100 flex justify-center">
           <button 
             onClick={onNext} 
             className="px-8 py-3 bg-slate-800 text-white rounded-full font-bold hover:bg-slate-700 transition-all shadow-lg hover:shadow-xl flex items-center gap-2 transform active:scale-95"
           >
             è¨˜ä½äº†ï¼Œé–‹å§‹ç·´ç¿’ï¼ <ArrowRight className="w-5 h-5" />
           </button>
        </div>
      </div>
    </div>
  );
};

// ==========================================
// ğŸ“ å­å…ƒä»¶ï¼šèª²å‰å°è®€ (Tutorial)
// ==========================================
const TutorialView = ({ onFinish }) => {
  const [step, setStep] = useState(1);
  const [highlightedBone, setHighlightedBone] = useState(null); 
  const [boneFeedback, setBoneFeedback] = useState(null); 
  const [quizState, setQuizState] = useState(null); 
  const [modifiers, setModifiers] = useState({ time: false, adj: false, adv: false, place: false });

  const handleBoneClick = (bone) => {
    setHighlightedBone(bone);
    let feedback = {};
    if (bone === 's') {
      feedback = { title: "Who (ä¸»è©)", desc: "å¥å­çš„ã€Œä¸»è§’ã€ï¼Œä¹Ÿå°±æ˜¯ã€Œèª°ã€åœ¨åšé€™ä»¶äº‹ã€‚", example: "ä¾‹å¦‚ï¼šThe boy, I, My father...", color: "blue", borderColor: "border-blue-200", bgColor: "bg-blue-50", textColor: "text-blue-700" };
    } else if (bone === 'v') {
      feedback = { title: "Action (å‹•ä½œ/å‹•è©)", desc: "å¥å­çš„ã€Œå¿ƒè‡Ÿã€ï¼Œæè¿°ä¸»è§’ã€Œåšã€äº†ä»€éº¼ã€‚", example: "ä¾‹å¦‚ï¼šeats, runs, is...", color: "red", borderColor: "border-red-200", bgColor: "bg-red-50", textColor: "text-red-700" };
    } else if (bone === 'o') {
      feedback = { title: "What/Whom (å—è©)", desc: "æ¥å—å‹•ä½œçš„å°è±¡ã€‚", example: "ä¾‹å¦‚ï¼šan apple, basketball...", color: "green", borderColor: "border-green-200", bgColor: "bg-green-50", textColor: "text-green-700" };
    }
    setBoneFeedback(feedback);
    setTimeout(() => setHighlightedBone(null), 800);
  };

  const handleQuizAnswer = (answer) => {
    if (answer === 'eats') { setQuizState('correct'); } else { setQuizState('wrong'); setTimeout(() => setQuizState(null), 1500); }
  };

  const toggleModifier = (key) => { setModifiers(prev => ({ ...prev, [key]: !prev[key] })); };

  return (
    <div className="min-h-screen bg-indigo-50 p-4 md:p-6 flex flex-col items-center justify-center animate-fade-in">
      <div className="max-w-4xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 flex flex-col min-h-[600px]">
        <div className="bg-indigo-600 p-6 text-white flex justify-between items-center shrink-0">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-white/20 rounded-xl"><GraduationCap className="w-6 h-6" /></div>
            <div><h2 className="text-xl font-bold tracking-wide">èª²å‰å°è®€ï¼šè‹±æ–‡é€ å¥é‚è¼¯</h2><div className="flex items-center gap-2 text-indigo-200 text-sm mt-1"><span>{step === 1 ? "Part 1: åŸºç¤éª¨æ¶" : "Part 2: æ“´å¥å±¤æ¬¡"}</span></div></div>
          </div>
          <button onClick={onFinish} className="text-sm font-medium hover:text-indigo-200 underline opacity-80 hover:opacity-100 transition-opacity">è·³éæ•™å­¸</button>
        </div>
        <div className="flex-1 p-6 md:p-10 flex flex-col items-center justify-center relative overflow-y-auto">
          {step === 1 && (
            <div className="w-full max-w-2xl space-y-6 text-center animate-slide-up">
              <div className="space-y-3"><h2 className="text-3xl font-bold text-slate-800">å¥å­çš„åŸºæœ¬éª¨æ¶</h2><p className="text-slate-500 text-lg">é»æ“Šä¸‹æ–¹çš„å¡ç‰‡ï¼Œèªè­˜å¥å­çš„ä¸‰å¤§æ ¸å¿ƒ</p></div>
              <div className="flex flex-col md:flex-row items-center justify-center gap-4 py-4 select-none">
                {['s', 'v', 'o'].map((bone) => (
                  <div key={bone} onClick={() => handleBoneClick(bone)} className={`cursor-pointer group relative w-32 h-28 md:w-40 md:h-32 bg-white border-2 rounded-2xl flex flex-col items-center justify-center shadow-sm transition-all duration-300 ${highlightedBone === bone ? 'border-indigo-500 ring-4 ring-indigo-100 bg-indigo-50' : 'border-slate-200 hover:border-indigo-500 hover:shadow-md hover:-translate-y-1'}`}>
                    <span className={`text-3xl md:text-4xl font-black mb-1 ${bone === 's' ? 'text-blue-600' : bone === 'v' ? 'text-red-500' : 'text-green-600'}`}>{bone === 's' ? 'Who' : bone === 'v' ? 'Action' : 'What'}</span>
                    <span className="text-xs md:text-sm font-bold text-slate-400">{bone === 's' ? 'ä¸»è©' : bone === 'v' ? 'å‹•ä½œ' : 'å—è©'}</span>
                  </div>
                ))}
              </div>
              <div className="min-h-[100px] flex items-center justify-center">{boneFeedback ? (<div className={`w-full p-4 rounded-xl border-2 ${boneFeedback.borderColor} ${boneFeedback.bgColor} animate-fade-in text-left flex gap-4 items-start`}><div><h4 className={`font-bold text-lg ${boneFeedback.textColor} mb-1`}>{boneFeedback.title}</h4><p className="text-slate-700 text-sm">{boneFeedback.desc}</p></div></div>) : (<div className="text-slate-400 flex items-center gap-2 bg-slate-50 px-6 py-4 rounded-xl border border-slate-100 border-dashed animate-pulse"><MousePointer2 className="w-5 h-5" /> è«‹é»æ“Šä¸Šæ–¹çš„å¡ç‰‡</div>)}</div>
              <hr className="border-slate-100 my-4" />
              <div className="space-y-4"><p className="text-slate-600 font-bold flex items-center justify-center gap-2">å°æ¸¬é©—ï¼šè«‹é»æ“Šé€™å¥è©±çš„ <span className="text-red-500 bg-red-50 px-2 py-0.5 rounded border border-red-100">Action (å‹•ä½œ)</span></p><div className="text-2xl md:text-3xl font-bold flex justify-center gap-4 font-mono text-slate-700"><button onClick={() => handleQuizAnswer('boy')} className="px-4 py-2 hover:bg-slate-100 rounded-xl transition-colors">The boy</button><button onClick={() => handleQuizAnswer('eats')} className={`px-4 py-2 rounded-xl transition-all ${quizState === 'correct' ? 'bg-red-500 text-white scale-110' : 'hover:bg-red-50'}`}>eats</button><button onClick={() => handleQuizAnswer('apple')} className="px-4 py-2 hover:bg-slate-100 rounded-xl transition-colors">an apple.</button></div></div>
              <div className="pt-4"><button onClick={() => setStep(2)} disabled={quizState !== 'correct'} className={`px-8 py-3 rounded-full font-bold transition-all shadow-lg flex items-center gap-2 mx-auto ${quizState === 'correct' ? 'bg-slate-800 text-white animate-bounce' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}>ä¸‹ä¸€æ­¥ <ArrowRight className="w-4 h-4" /></button></div>
            </div>
          )}
          {step === 2 && (
            <div className="w-full max-w-4xl space-y-6 text-center animate-slide-up">
              <div className="space-y-3"><h2 className="text-3xl font-bold text-slate-800">å¥å­çš„çµ„æˆå±¤æ¬¡</h2><p className="text-slate-500 text-lg">åŸºæœ¬çš„å¥å­å¾ˆçŸ­ï¼Œæ‰“é–‹é–‹é—œå¹«å®ƒåŠ æ–™ï¼</p></div>
              <div className="py-6"><div className="bg-slate-800 border-4 border-slate-700 rounded-2xl p-8 md:p-12 shadow-2xl relative flex flex-wrap justify-center items-center gap-x-2 gap-y-4 text-2xl md:text-4xl font-medium leading-relaxed min-h-[220px] transition-all">
                  {modifiers.time && <span className="animate-pop-in text-purple-300 font-bold border-b-2 border-purple-300/30">On a sunny day,</span>}
                  <span className="text-white">a</span>{modifiers.adj && <span className="animate-pop-in text-pink-300 font-bold border-b-2 border-pink-300/30">happy</span>}
                  <span className="relative group cursor-default"><span className="text-white font-bold">dog</span><div className="h-1 w-full bg-blue-500 mt-1 rounded-full opacity-50"></div><span className="text-[10px] text-blue-400 font-bold absolute -bottom-5 left-1/2 -translate-x-1/2 uppercase tracking-widest">Who</span></span>
                  <span className="relative group cursor-default ml-2"><span className="text-white font-bold">is running</span><div className="h-1 w-full bg-red-500 mt-1 rounded-full opacity-50"></div><span className="text-[10px] text-red-400 font-bold absolute -bottom-5 left-1/2 -translate-x-1/2 uppercase tracking-widest">Action</span></span>
                  {modifiers.adv && <span className="animate-pop-in text-amber-300 font-bold border-b-2 border-amber-300/30 ml-2">excitedly</span>}
                  {modifiers.place && <span className="animate-pop-in text-emerald-300 font-bold border-b-2 border-emerald-300/30 ml-2">in the park.</span>}
              </div></div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-3xl mx-auto">{Object.keys(modifiers).map(key => (<button key={key} onClick={() => toggleModifier(key)} className="p-4 rounded-xl border-2 border-slate-200 bg-white hover:bg-slate-50 transition-all flex flex-col items-center gap-3 group active:scale-95"><div className={`w-14 h-8 rounded-full relative transition-colors duration-300 ${modifiers[key] ? 'bg-indigo-200' : 'bg-slate-200'}`}><div className={`w-6 h-6 bg-white rounded-full shadow-md border border-slate-200 absolute top-1 left-1 transition-transform duration-300 ${modifiers[key] ? 'translate-x-6 bg-indigo-600 border-indigo-600' : ''}`}></div></div><span className="font-bold text-sm text-slate-500">{key}</span></button>))}</div>
              <div className="pt-8 pb-4"><button onClick={onFinish} className="w-full max-w-sm mx-auto py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg animate-bounce">é–‹å§‹å¯¦æˆ°ç·´ç¿’ï¼</button></div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// ==========================================
// ğŸ—ºï¸ å­å…ƒä»¶ï¼šå¯«ä½œåœ°åœ– (Story Flow Tracker)
// ==========================================
const StoryFlow = ({ currentStep }) => {
  const steps = [
    { label: "ç¾åœ¨ç•«é¢", icon: ImageIcon, tip: "å®¢è§€æè¿°ä½ çœ‹åˆ°çš„" },
    { label: "æˆ‘æƒ³åƒç™¼ç”Ÿäº†ä»€éº¼", icon: Sparkles, tip: "æ¨æ¸¬å‹•ä½œèˆ‡é—œä¿‚" },
    { label: "ä»–å€‘çš„æ„Ÿå—", icon: Activity, tip: "æè¿°å¿ƒæƒ…èˆ‡æ°›åœ" },
    { label: "æº«é¦¨çµå°¾", icon: Star, tip: "çµ¦äºˆæ­£é¢ç¸½çµ" },
  ];

  return (
    <div className="w-full bg-indigo-50/50 rounded-2xl border border-indigo-100 p-4 md:p-5 mb-4 animate-fade-in relative overflow-hidden">
      <div className="absolute top-0 left-0 w-full h-1 bg-indigo-100"></div>
      
      <h3 className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-4 flex items-center gap-2">
        <MapPin className="w-3 h-3" /> å¯«ä½œå°èˆª (Structure Map)
      </h3>

      <div className="flex justify-between items-start relative px-2">
        {/* Progress Bar Background Line */}
        <div className="absolute top-4 left-4 right-4 h-0.5 bg-slate-200 -z-0 rounded-full" />
        
        {/* Active Progress Line */}
        <div 
            className="absolute top-4 left-4 h-0.5 bg-indigo-500 -z-0 transition-all duration-500"
            style={{ width: `${Math.min((currentStep / (steps.length - 1)) * 100, 100)}%` }} 
        />

        {steps.map((step, index) => {
          const isActive = index === currentStep;
          const isCompleted = index < currentStep;
          const Icon = step.icon;

          return (
            <div key={index} className="relative z-10 flex flex-col items-center gap-2 group w-1/4">
              {/* Icon Circle */}
              <div 
                className={`
                  w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 bg-white
                  ${isActive 
                    ? 'border-indigo-600 text-indigo-600 shadow-md ring-4 ring-indigo-50 scale-110' 
                    : isCompleted 
                      ? 'border-green-500 bg-green-500 text-white' 
                      : 'border-slate-200 text-slate-300'
                  }
                `}
              >
                {isCompleted ? <Check className="w-4 h-4 md:w-5 md:h-5" /> : <Icon className="w-4 h-4 md:w-5 md:h-5" />}
              </div>
              
              {/* Text Label */}
              <div className="text-center flex flex-col items-center">
                <span 
                  className={`
                    text-[10px] md:text-xs font-bold transition-colors duration-300 leading-tight
                    ${isActive ? 'text-indigo-700' : isCompleted ? 'text-green-600' : 'text-slate-400'}
                  `}
                >
                  {step.label}
                </span>
                
                {/* Active Tip Bubble */}
                {isActive && (
                  <span className="hidden md:inline-block mt-1 text-[10px] text-indigo-400 bg-indigo-50 px-2 py-0.5 rounded-full border border-indigo-100 whitespace-nowrap animate-slide-up-sm">
                    {step.tip}
                  </span>
                )}
              </div>
            </div>
          );
        })}
      </div>
      
      {/* Mobile Tip Display */}
      <div className="md:hidden mt-4 text-center">
         <p className="text-xs text-indigo-600 bg-indigo-100 inline-block px-3 py-1 rounded-full animate-fade-in">
           ğŸ’¡ æç¤ºï¼š{steps[currentStep]?.tip || "å®Œæˆï¼"}
         </p>
      </div>
    </div>
  );
};

// ==========================================
// ğŸš€ ä¸»ç¨‹å¼
// ==========================================
const OneSentenceApp = () => {
  const [showTutorial, setShowTutorial] = useState(false);
  const [activeScenarioId, setActiveScenarioId] = useState(null);
  const [showTips, setShowTips] = useState(false);
  const [mode, setMode] = useState('building'); 
  const [currentSentenceIndex, setCurrentSentenceIndex] = useState(0); 
  const [currentPartIndex, setCurrentPartIndex] = useState(0); 
  
  // ğŸŒŸ ç‹€æ…‹æ›´æ–°ï¼šåˆ†åˆ¥å„²å­˜è‹±æ–‡éƒ¨åˆ†èˆ‡ä¸­æ–‡éƒ¨åˆ†
  const [currentSentenceParts, setCurrentSentenceParts] = useState([]); 
  const [currentSentenceTranslations, setCurrentSentenceTranslations] = useState([]); 

  // ğŸŒŸ ç‹€æ…‹æ›´æ–°ï¼šæ­·å²ç´€éŒ„ç¾åœ¨å„²å­˜ç‰©ä»¶ { english, chinese }
  const [fullSpeechHistory, setFullSpeechHistory] = useState([]);
  
  const [isProcessing, setIsProcessing] = useState(false);
  const historyEndRef = useRef(null);

  useEffect(() => {
    historyEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [fullSpeechHistory]);

  // --- æ•™æè³‡æ–™åº« ---
  const scenarios = {
    cafe: {
      id: 'cafe',
      title: 'é¡Œç›® 1 | å’–å•¡åº— (æ—¥å¸¸)',
      icon: <Coffee className="w-8 h-8" />,
      color: 'amber',
      description: "ç•«é¢æè¿°ï¼šä¸€å®¶é™½å…‰æ™®ç…§çš„å’–å•¡åº—è£¡ï¼Œä¸€ä½å¹´è¼•å¥³ç”Ÿååœ¨çª—é‚Šï¼Œå°é¢åè‘—ä¸€ä½å¹´é•·ç”·æ€§ã€‚æ¡Œä¸Šæœ‰å…©æ¯å’–å•¡ï¼Œå…©äººè¡¨æƒ…æ”¾é¬†ï¼Œæ­£åœ¨èŠå¤©ã€‚",
      sentences: [
        {
          id: 's1',
          label: 'ç¬¬ä¸€å¥ï¼šæè¿°ç•«é¢ (The Scene)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šèª° + åœ¨å“ªè£¡',
          parts: [
            { type: 'é–‹é ­å¼•å°', grammarRole: 'Intro', question: 'æˆ‘å€‘å…ˆç”¨ä¸€å€‹å¸¸è¦‹çš„é–‹é ­ï¼š', options: [{ text: "In this picture,", translation: "åœ¨é€™å¼µåœ–ä¸­" }, { text: "At first glance,", translation: "ä¹çœ‹ä¹‹ä¸‹" }, { text: "Looking at the photo,", translation: "çœ‹è‘—é€™å¼µç…§ç‰‡" }] },
            { type: 'ä¸»è© (Who)', grammarRole: 'Subject', question: 'åœ–ç‰‡ä¸­ä¸»è¦çš„äººç‰©æ˜¯èª°ï¼Ÿ', options: [{ text: "I see a young woman", translation: "æˆ‘çœ‹è¦‹ä¸€ä½å¹´è¼•å¥³å­" }, { text: "there is a student", translation: "æœ‰ä¸€ä½å­¸ç”Ÿ" }, { text: "I notice a lonely girl", translation: "æˆ‘æ³¨æ„åˆ°ä¸€ä½å­¤å–®çš„å¥³å­©" }, { text: "I see a waitress", translation: "æˆ‘çœ‹è¦‹ä¸€ä½å¥³æœå‹™ç”Ÿ" }] },
            { type: 'æƒ…å¢ƒ/åœ°é» (Where)', grammarRole: 'Place/Context', question: 'å¥¹åœ¨å“ªè£¡ï¼Ÿç’°å¢ƒå¦‚ä½•ï¼Ÿ', options: [{ text: "sitting in a sunny cafe.", translation: "ååœ¨é™½å…‰æ™®ç…§çš„å’–å•¡å»³" }, { text: "standing in a busy shop.", translation: "ç«™åœ¨å¿™ç¢Œçš„å•†åº—" }, { text: "studying in a library.", translation: "åœ¨åœ–æ›¸é¤¨è®€æ›¸" }] }
          ]
        },
        {
          id: 's2',
          label: 'ç¬¬äºŒå¥ï¼šç™¼æ®æƒ³åƒ (Imagination)',
          subLabel: 'è¤‡åˆå¥æ§‹ï¼šé€£æ¥è© + æ¨æ¸¬ + å‹•ä½œ',
          parts: [
             { type: 'é€£æ¥è©', grammarRole: 'Connect', question: 'é€£æ¥ä¸‹ä¸€å¥...', options: [{ text: "She sits opposite a man", translation: "å¥¹ååœ¨ä¸€ä½ç”·å£«å°é¢" }, { text: "She is alone", translation: "å¥¹ç¨è‡ªä¸€äºº" }] },
             { type: 'æ¨æ¸¬', grammarRole: 'Guess', question: 'é—œä¿‚æ˜¯ï¼Ÿ', options: [{ text: "and I imagine they are father and daughter", translation: "æˆ‘æƒ³åƒæ˜¯çˆ¶å¥³" }, { text: "and they look like strangers", translation: "åƒæ˜¯é™Œç”Ÿäºº" }] },
             { type: 'å‹•ä½œ', grammarRole: 'Action', question: 'æ­£åœ¨åšä»€éº¼ï¼Ÿ', options: [{ text: "having a nice chat.", translation: "æ„‰å¿«åœ°èŠå¤©" }, { text: "fighting.", translation: "åµæ¶" }] }
          ]
        },
        {
            id: 's3',
            label: 'ç¬¬ä¸‰å¥ï¼šæè¿°æ„Ÿå— (Feelings)',
            subLabel: 'æè¿°å¥æ§‹ï¼šä¸»è© + å½¢å®¹è©',
            parts: [
                { type: 'ä¸»è©', grammarRole: 'Subject', question: 'ä»–å€‘çœ‹èµ·ä¾†...', options: [{ text: "They look", translation: "ä»–å€‘çœ‹èµ·ä¾†" }, { text: "They feel", translation: "ä»–å€‘æ„Ÿè¦º" }] },
                { type: 'å½¢å®¹è©', grammarRole: 'Adjective', question: 'æ°£æ°›å¦‚ä½•ï¼Ÿ', options: [{ text: "relaxed and happy", translation: "æ”¾é¬†ä¸”å¿«æ¨‚" }, { text: "nervous", translation: "ç·Šå¼µ" }] },
                { type: 'åŸå› ', grammarRole: 'Reason', question: 'ç‚ºä»€éº¼ï¼Ÿ', options: [{ text: "enjoying the coffee.", translation: "äº«å—å’–å•¡" }, { text: "wanting to leave.", translation: "æƒ³é›¢é–‹" }] }
            ]
        },
        {
            id: 's4',
            label: 'ç¬¬å››å¥ï¼šç¸½çµ (Conclusion)',
            subLabel: 'ç¸½çµå¥æ§‹ï¼šå•Ÿç™¼ + è§€é»',
            parts: [
                { type: 'é–‹é ­', grammarRole: 'Opener', question: 'ç¸½çµä¾†èªª...', options: [{ text: "This picture reminds me", translation: "é€™å¼µåœ–æé†’æˆ‘" }, { text: "I think", translation: "æˆ‘æƒ³" }] },
                { type: 'ä¸»é¡Œ', grammarRole: 'Topic', question: 'ä»€éº¼å¾ˆé‡è¦ï¼Ÿ', options: [{ text: "family time", translation: "å®¶åº­æ™‚å…‰" }, { text: "money", translation: "é‡‘éŒ¢" }] },
                { type: 'åƒ¹å€¼', grammarRole: 'Value', question: 'åƒ¹å€¼æ˜¯ï¼Ÿ', options: [{ text: "is precious.", translation: "å¾ˆçè²´" }, { text: "is boring.", translation: "å¾ˆç„¡èŠ" }] }
            ]
        }
      ]
    },
    bus: {
      id: 'bus',
      title: 'é¡Œç›® 2 | å…¬è»Šç«™ (æƒ…ç·’)',
      icon: <CloudRain className="w-8 h-8" />,
      color: 'blue',
      description: "ç•«é¢æè¿°ï¼šä¸‹é›¨å¤©ï¼Œä¸€ä½ç”·å­æ’è‘—å‚˜ç«™åœ¨å…¬è»Šç«™ï¼Œæ—é‚Šæœ‰ä¸€ä½å°å¥³å­©èƒŒè‘—æ›¸åŒ…ã€‚é›–ç„¶å¤©æ°£é™°é›¨ï¼Œä½†å…©äººé å¾—å¾ˆè¿‘ï¼Œæ„Ÿè¦ºå¾ˆæº«é¦¨ã€‚",
      sentences: [
        {
          id: 's1',
          label: 'ç¬¬ä¸€å¥ï¼šæè¿°ç•«é¢ (The Scene)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šèƒŒæ™¯ + ä¸»è© + å‹•ä½œ + åœ°é»',
          parts: [
            { type: 'èƒŒæ™¯ (Setting)', grammarRole: 'Time/Weather', question: 'é¦–å…ˆæè¿°å¤©æ°£èˆ‡åœ°é»', options: [{ text: "On a rainy day,", translation: "åœ¨ä¸€å€‹ä¸‹é›¨å¤©" }, { text: "On a sunny day,", translation: "åœ¨ä¸€å€‹æ™´å¤©" }] },
            { type: 'äººç‰© (Who)', grammarRole: 'Subject', question: 'ä½ çœ‹è¦‹äº†èª°ï¼Ÿ', options: [{ text: "a man and a little girl", translation: "ä¸€ä½ç”·å­å’Œå°å¥³å­©" }, { text: "two boys", translation: "å…©å€‹ç”·å­©" }] },
            { type: 'å‹•ä½œ (Action)', grammarRole: 'Verb + Place', question: 'ä»–å€‘åœ¨åšä»€éº¼ï¼Ÿ', options: [{ text: "are waiting at a bus stop.", translation: "æ­£åœ¨å…¬è»Šç«™ç­‰è»Š" }, { text: "are playing.", translation: "æ­£åœ¨ç©" }] }
          ]
        },
         {
          id: 's2',
          label: 'ç¬¬äºŒå¥ï¼šç™¼æ®æƒ³åƒ (Imagination)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šæ¨æ¸¬ + ç´°ç¯€',
          parts: [
            { type: 'ç´°ç¯€', grammarRole: 'Detail', question: 'çœ‹å‹•ä½œ...', options: [{ text: "The man holds an umbrella", translation: "ç”·å­æ‹¿è‘—å‚˜" }, { text: "They have no umbrella", translation: "ä»–å€‘æ²’å‚˜" }] },
            { type: 'æ¨æ¸¬', grammarRole: 'Guess', question: 'é€™ä»£è¡¨...', options: [{ text: "trying to protect her.", translation: "è©¦åœ–ä¿è­·å¥¹" }, { text: "ignoring her.", translation: "ä¸ç†å¥¹" }] },
            { type: 'é—œä¿‚', grammarRole: 'Relation', question: 'é—œä¿‚æ˜¯...', options: [{ text: "They seem like family.", translation: "ä»–å€‘çœ‹èµ·ä¾†åƒå®¶äºº" }, { text: "They are strangers.", translation: "ä»–å€‘æ˜¯é™Œç”Ÿäºº" }] }
          ]
        },
        {
          id: 's3',
          label: 'ç¬¬ä¸‰å¥ï¼šæ„Ÿå— (Feelings)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šé›–ç„¶...ä½†æ˜¯...',
          parts: [
             { type: 'è½‰æŠ˜', grammarRole: 'Contrast', question: 'é›–ç„¶...', options: [{ text: "Even though it rains,", translation: "é›–ç„¶ä¸‹é›¨" }, { text: "Because it is hot,", translation: "å› ç‚ºå¾ˆç†±" }] },
             { type: 'ä¸»è©', grammarRole: 'Subject', question: 'ä»–å€‘æ„Ÿè¦º...', options: [{ text: "they feel warm", translation: "ä»–å€‘æ„Ÿåˆ°æº«æš–" }, { text: "they feel cold", translation: "ä»–å€‘æ„Ÿåˆ°å†·" }] },
             { type: 'åŸå› ', grammarRole: 'Reason', question: 'å› ç‚º...', options: [{ text: "being together.", translation: "åœ¨ä¸€èµ·" }, { text: "being alone.", translation: "ç¨è‡ªä¸€äºº" }] }
          ]
        },
        {
          id: 's4',
          label: 'ç¬¬å››å¥ï¼šç¸½çµ (Conclusion)',
          subLabel: 'ç¸½çµå¥æ§‹ï¼šå¿ƒå¾—',
          parts: [
             { type: 'é–‹é ­', grammarRole: 'Intro', question: 'é€™è®“æˆ‘æƒ³åˆ°...', options: [{ text: "This shows that", translation: "é€™é¡¯ç¤ºäº†" }, { text: "I dislike", translation: "æˆ‘ä¸å–œæ­¡" }] },
             { type: 'æ ¸å¿ƒ', grammarRole: 'Core', question: 'ä»€éº¼åŠ›é‡ï¼Ÿ', options: [{ text: "love warms everything.", translation: "æ„›æº«æš–ä¸€åˆ‡" }, { text: "rain is wet.", translation: "é›¨æ˜¯æ¿•çš„" }] },
             { type: 'çµå°¾', grammarRole: 'Ending', question: 'æ„Ÿå—...', options: [{ text: "It is touching.", translation: "å¾ˆæ„Ÿäºº" }, { text: "It is sad.", translation: "å¾ˆé›£é" }] }
          ]
        }
      ]
    },
    // ğŸŒŸ æ–°å¢é¡Œç›® 3: é¤å»³ç´„æœƒ
    date: {
      id: 'date',
      title: 'é¡Œç›® 3 | é¤å»³ç´„æœƒ (äº’å‹•)',
      icon: <Heart className="w-8 h-8" />,
      color: 'pink',
      description: "ç•«é¢æè¿°ï¼šä¸€å°ç”·å¥³åœ¨æ°£æ°›æº«é¦¨çš„é¤å»³è£¡ç”¨é¤ï¼Œæ¡Œä¸Šæœ‰ç¾é£Ÿèˆ‡ç´…é…’ã€‚å…©äººç›¸è«‡ç”šæ­¡ï¼Œç¬‘å¾—å¾ˆé–‹å¿ƒï¼Œæ°£æ°›çœ‹èµ·ä¾†éå¸¸æµªæ¼«ã€‚",
      sentences: [
        {
          id: 's1',
          label: 'ç¬¬ä¸€å¥ï¼šæè¿°ç•«é¢ (The Scene)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šèª° + åœ¨å“ªè£¡',
          parts: [
            { type: 'é–‹é ­å¼•å°', grammarRole: 'Intro', question: 'æˆ‘å€‘å¾å ´æ™¯é–‹å§‹ï¼š', options: [{ text: "In a cozy restaurant,", translation: "åœ¨ä¸€é–“èˆ’é©çš„é¤å»³è£¡" }, { text: "In a noisy bar,", translation: "åœ¨ä¸€é–“åµé›œçš„é…’å§è£¡" }, { text: "Outside a shop,", translation: "åœ¨ä¸€é–“åº—å¤–é¢" }] },
            { type: 'ä¸»è© (Who)', grammarRole: 'Subject', question: 'ä½ çœ‹è¦‹äº†èª°ï¼Ÿ', options: [{ text: "a couple is sitting", translation: "ä¸€å°æƒ…ä¾¶åè‘—" }, { text: "two colleagues are standing", translation: "å…©ä½åŒäº‹ç«™è‘—" }, { text: "a family is eating", translation: "ä¸€å€‹å®¶åº­åœ¨åƒé£¯" }] },
            { type: 'åœ°é»ç´°ç¯€ (Where)', grammarRole: 'Detail', question: 'ä»–å€‘ååœ¨å“ªï¼Ÿ', options: [{ text: "at a table with food and wine.", translation: "åœ¨æœ‰é£Ÿç‰©å’Œé…’çš„æ¡Œé‚Š" }, { text: "near the exit.", translation: "åœ¨å‡ºå£é™„è¿‘" }] }
          ]
        },
        {
          id: 's2',
          label: 'ç¬¬äºŒå¥ï¼šç™¼æ®æƒ³åƒ (Imagination)',
          subLabel: 'è¤‡åˆå¥æ§‹ï¼šå‹•ä½œ + æ¨æ¸¬',
          parts: [
            { type: 'å‹•ä½œ', grammarRole: 'Action', question: 'ä»–å€‘æ­£åœ¨åšä»€éº¼ï¼Ÿ', options: [{ text: "They are laughing and talking,", translation: "ä»–å€‘æ­£åœ¨èªªç¬‘" }, { text: "They are looking at phones,", translation: "ä»–å€‘æ­£åœ¨çœ‹æ‰‹æ©Ÿ" }] },
            { type: 'é€£æ¥è©', grammarRole: 'Link', question: 'é€£æ¥ä½ çš„æƒ³æ³•...', options: [{ text: "and I imagine", translation: "æˆ‘æƒ³åƒ" }, { text: "but I think", translation: "ä½†æˆ‘èªç‚º" }] },
            { type: 'æ¨æ¸¬', grammarRole: 'Guess', question: 'ä»–å€‘åœ¨æ…¶ç¥ä»€éº¼ï¼Ÿ', options: [{ text: "they are on a date.", translation: "ä»–å€‘åœ¨ç´„æœƒ" }, { text: "they are having a meeting.", translation: "ä»–å€‘åœ¨é–‹æœƒ" }] }
          ]
        },
        {
          id: 's3',
          label: 'ç¬¬ä¸‰å¥ï¼šæè¿°æ„Ÿå— (Feelings)',
          subLabel: 'æè¿°å¥æ§‹ï¼šä¸»è© + å½¢å®¹è©',
          parts: [
            { type: 'ä¸»è©', grammarRole: 'Subject', question: 'çœ‹è‘—ä»–å€‘...', options: [{ text: "They look", translation: "ä»–å€‘çœ‹èµ·ä¾†" }, { text: "They seem", translation: "ä»–å€‘ä¼¼ä¹" }] },
            { type: 'å½¢å®¹è©', grammarRole: 'Adjective', question: 'æ„Ÿè¦ºå¦‚ä½•ï¼Ÿ', options: [{ text: "very happy and romantic", translation: "éå¸¸å¿«æ¨‚ä¸”æµªæ¼«" }, { text: "bored and tired", translation: "ç„¡èŠä¸”ç–²æ†Š" }] },
            { type: 'ç‹€æ…‹', grammarRole: 'State', question: 'æ²ˆæµ¸åœ¨...', options: [{ text: "enjoying each other's company.", translation: "äº«å—å½¼æ­¤çš„é™ªä¼´" }, { text: "waiting for the bill.", translation: "ç­‰å¾…å¸³å–®" }] }
          ]
        },
        {
          id: 's4',
          label: 'ç¬¬å››å¥ï¼šç¸½çµ (Conclusion)',
          subLabel: 'ç¸½çµå¥æ§‹ï¼šå•Ÿç™¼',
          parts: [
            { type: 'é–‹é ­', grammarRole: 'Opener', question: 'é€™è®“æˆ‘æƒ³åˆ°...', options: [{ text: "This reminds me that", translation: "é€™æé†’äº†æˆ‘" }, { text: "I don't think", translation: "æˆ‘ä¸èªç‚º" }] },
            { type: 'ä¸»é¡Œ', grammarRole: 'Topic', question: 'é—œæ–¼ç›¸è™•...', options: [{ text: "spending time with loved ones", translation: "èˆ‡æ„›äººå…±åº¦æ™‚å…‰" }, { text: "eating alone", translation: "ç¨è‡ªåƒé£¯" }] },
            { type: 'è§€é»', grammarRole: 'View', question: 'æ˜¯æ€éº¼æ¨£çš„ï¼Ÿ', options: [{ text: "is wonderful.", translation: "æ˜¯å¾ˆç¾å¥½çš„" }, { text: "is a waste of time.", translation: "æ˜¯æµªè²»æ™‚é–“" }] }
          ]
        }
      ]
    },
    // ğŸŒŸ æ–°å¢é¡Œç›® 4: ä¾¿åˆ©å•†åº—
    store: {
      id: 'store',
      title: 'é¡Œç›® 4 | ä¾¿åˆ©å•†åº— (é¸æ“‡)',
      icon: <ShoppingBasket className="w-8 h-8" />,
      color: 'emerald',
      description: "ç•«é¢æè¿°ï¼šä¸€ä½å¥³ç”Ÿåœ¨ä¾¿åˆ©å•†åº—çš„è²¨æ¶å‰ï¼Œæ‰‹è£¡æ‹¿è‘—ä¸€ç“¶ç‰›å¥¶æ­£åœ¨ä»”ç´°æŸ¥çœ‹æ¨™ç±¤ã€‚è²¨æ¶ä¸Šæ“ºæ»¿äº†å„ç¨®é›¶é£Ÿã€‚",
      sentences: [
        {
          id: 's1',
          label: 'ç¬¬ä¸€å¥ï¼šæè¿°ç•«é¢ (The Scene)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šåœ°é» + äººç‰© + å‹•ä½œ',
          parts: [
             { type: 'åœ°é» (Where)', grammarRole: 'Place', question: 'åœ¨å“ªè£¡ï¼Ÿ', options: [{ text: "In a bright convenience store,", translation: "åœ¨ä¸€é–“æ˜äº®çš„ä¾¿åˆ©å•†åº—" }, { text: "In a dark room,", translation: "åœ¨ä¸€é–“æš—æˆ¿" }] },
             { type: 'äººç‰© (Who)', grammarRole: 'Subject', question: 'æ˜¯èª°ï¼Ÿ', options: [{ text: "a woman is standing", translation: "ä¸€ä½å¥³å­ç«™è‘—" }, { text: "a child is running", translation: "ä¸€å€‹å°å­©è·‘è‘—" }] },
             { type: 'å‹•ä½œ (Action)', grammarRole: 'Verb', question: 'åœ¨åšä»€éº¼ï¼Ÿ', options: [{ text: "looking at a bottle of milk.", translation: "çœ‹è‘—ä¸€ç“¶ç‰›å¥¶" }, { text: "buying a newspaper.", translation: "è²·å ±ç´™" }] }
          ]
        },
        {
          id: 's2',
          label: 'ç¬¬äºŒå¥ï¼šç™¼æ®æƒ³åƒ (Imagination)',
          subLabel: 'è¤‡åˆå¥æ§‹ï¼šç´°ç¯€ + æ¨æ¸¬',
          parts: [
             { type: 'ç´°ç¯€', grammarRole: 'Detail', question: 'å¥¹æ­£åœ¨åšä»€éº¼ç´°ç¯€å‹•ä½œï¼Ÿ', options: [{ text: "She is reading the label,", translation: "å¥¹æ­£åœ¨è®€æ¨™ç±¤" }, { text: "She is drinking it,", translation: "å¥¹æ­£åœ¨å–" }] },
             { type: 'é€£æ¥è©', grammarRole: 'Link', question: 'æ‰€ä»¥æˆ‘çŒœ...', options: [{ text: "and I guess", translation: "æ‰€ä»¥æˆ‘çŒœ" }, { text: "but I doubt", translation: "ä½†æˆ‘æ‡·ç–‘" }] },
             { type: 'æ¨æ¸¬', grammarRole: 'Guess', question: 'å¥¹åœ¨ç¢ºèªä»€éº¼ï¼Ÿ', options: [{ text: "she is checking the expiry date.", translation: "å¥¹åœ¨ç¢ºèªæœ‰æ•ˆæœŸé™" }, { text: "she is looking for the price.", translation: "å¥¹åœ¨æ‰¾åƒ¹æ ¼" }] }
          ]
        },
        {
          id: 's3',
          label: 'ç¬¬ä¸‰å¥ï¼šæè¿°æ„Ÿå— (Feelings)',
          subLabel: 'æè¿°å¥æ§‹ï¼šä¸»è© + å½¢å®¹è©',
          parts: [
             { type: 'ä¸»è©', grammarRole: 'Subject', question: 'å¥¹çš„è¡¨æƒ…...', options: [{ text: "She looks", translation: "å¥¹çœ‹èµ·ä¾†" }, { text: "She sounds", translation: "å¥¹è½èµ·ä¾†" }] },
             { type: 'å½¢å®¹è©', grammarRole: 'Adjective', question: 'æ˜¯æ€æ¨£çš„ï¼Ÿ', options: [{ text: "serious and focused", translation: "åš´è‚…ä¸”å°ˆæ³¨" }, { text: "angry and loud", translation: "ç”Ÿæ°£ä¸”å¤§è²" }] },
             { type: 'è£œå……', grammarRole: 'Context', question: 'é—œæ–¼ä»€éº¼ï¼Ÿ', options: [{ text: "on making a choice.", translation: "åœ¨åšé¸æ“‡" }, { text: "on leaving the store.", translation: "åœ¨é›¢é–‹å•†åº—" }] }
          ]
        },
        {
          id: 's4',
          label: 'ç¬¬å››å¥ï¼šç¸½çµ (Conclusion)',
          subLabel: 'ç¸½çµå¥æ§‹ï¼šè§€é»',
          parts: [
             { type: 'é–‹é ­', grammarRole: 'Opener', question: 'é€™å€‹ç•«é¢é¡¯ç¤º...', options: [{ text: "This shows that", translation: "é€™é¡¯ç¤ºäº†" }, { text: "I wonder if", translation: "æˆ‘æƒ³çŸ¥é“æ˜¯å¦" }] },
             { type: 'ä¸»é¡Œ', grammarRole: 'Topic', question: 'é—œæ–¼æ—¥å¸¸...', options: [{ text: "we should pay attention to", translation: "æˆ‘å€‘æ‡‰è©²æ³¨æ„" }, { text: "we can ignore", translation: "æˆ‘å€‘å¯ä»¥å¿½ç•¥" }] },
             { type: 'å—è©', grammarRole: 'Object', question: 'ä»€éº¼äº‹æƒ…ï¼Ÿ', options: [{ text: "what we eat.", translation: "æˆ‘å€‘åƒä»€éº¼" }, { text: "the music.", translation: "éŸ³æ¨‚" }] }
          ]
        }
      ]
    },
    // ğŸŒŸ æ–°å¢é¡Œç›® 5: å®¶åº­è³¼ç‰©
    family: {
      id: 'family',
      title: 'é¡Œç›® 5 | å®¶åº­è³¼ç‰© (æ­¡æ¨‚)',
      icon: <ShoppingBag className="w-8 h-8" />,
      color: 'orange',
      description: "ç•«é¢æè¿°ï¼šä¸€å®¶å››å£èµ°åœ¨è¡—é“ä¸Šï¼Œæ¯å€‹äººæ‰‹è£¡éƒ½æè‘—è³¼ç‰©è¢‹ï¼Œè‡‰ä¸Šæ›è‘—ç‡¦çˆ›çš„ç¬‘å®¹ï¼Œçœ‹èµ·ä¾†å‰›çµæŸä¸€å ´æ„‰å¿«çš„è³¼ç‰©ä¹‹æ—…ã€‚",
      sentences: [
        {
          id: 's1',
          label: 'ç¬¬ä¸€å¥ï¼šæè¿°ç•«é¢ (The Scene)',
          subLabel: 'åŸºæœ¬å¥æ§‹ï¼šåœ°é» + äººç‰© + å‹•ä½œ',
          parts: [
            { type: 'åœ°é»', grammarRole: 'Place', question: 'åœ¨ä»€éº¼åœ°æ–¹ï¼Ÿ', options: [{ text: "On a beautiful street,", translation: "åœ¨ä¸€æ¢ç¾éº—çš„è¡—é“ä¸Š" }, { text: "In a dark alley,", translation: "åœ¨ä¸€æ¢æš—å··è£¡" }] },
            { type: 'äººç‰©', grammarRole: 'Subject', question: 'æœ‰èª°ï¼Ÿ', options: [{ text: "a family of four", translation: "ä¸€å®¶å››å£" }, { text: "a group of students", translation: "ä¸€ç¾¤å­¸ç”Ÿ" }] },
            { type: 'å‹•ä½œ', grammarRole: 'Action', question: 'åœ¨åšä»€éº¼ï¼Ÿ', options: [{ text: "is walking together.", translation: "æ­£èµ°åœ¨ä¸€èµ·" }, { text: "is running away.", translation: "æ­£è·‘èµ°" }] }
          ]
        },
        {
          id: 's2',
          label: 'ç¬¬äºŒå¥ï¼šç™¼æ®æƒ³åƒ (Imagination)',
          subLabel: 'è¤‡åˆå¥æ§‹ï¼šç´°ç¯€ + æƒ³åƒ',
          parts: [
            { type: 'ç´°ç¯€', grammarRole: 'Detail', question: 'ä»–å€‘æ‰‹è£¡æ‹¿è‘—ï¼Ÿ', options: [{ text: "They are holding shopping bags,", translation: "ä»–å€‘æè‘—è³¼ç‰©è¢‹" }, { text: "They are holding books,", translation: "ä»–å€‘æ‹¿è‘—æ›¸" }] },
            { type: 'é€£æ¥è©', grammarRole: 'Link', question: 'æ‰€ä»¥æˆ‘çŒœ...', options: [{ text: "and I imagine", translation: "æˆ‘æƒ³åƒ" }, { text: "but I feel", translation: "ä½†æˆ‘æ„Ÿè¦º" }] },
            { type: 'æ¨æ¸¬', grammarRole: 'Guess', question: 'ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ', options: [{ text: "they bought many gifts.", translation: "ä»–å€‘è²·äº†å¾ˆå¤šç¦®ç‰©" }, { text: "they lost their way.", translation: "ä»–å€‘è¿·è·¯äº†" }] }
          ]
        },
        {
          id: 's3',
          label: 'ç¬¬ä¸‰å¥ï¼šæè¿°æ„Ÿå— (Feelings)',
          subLabel: 'æè¿°å¥æ§‹ï¼šä¸»è© + å½¢å®¹è©',
          parts: [
            { type: 'ä¸»è©', grammarRole: 'Subject', question: 'ä»–å€‘çš„æ„Ÿè¦º...', options: [{ text: "They feel", translation: "ä»–å€‘æ„Ÿè¦º" }, { text: "They look", translation: "ä»–å€‘çœ‹èµ·ä¾†" }] },
            { type: 'å½¢å®¹è©', grammarRole: 'Adjective', question: 'æ˜¯æ€æ¨£çš„ï¼Ÿ', options: [{ text: "excited and full of joy", translation: "èˆˆå¥®ä¸”å……æ»¿å–œæ‚…" }, { text: "tired and hungry", translation: "ç´¯ä¸”é¤“" }] },
            { type: 'åŸå› ', grammarRole: 'Reason', question: 'å› ç‚º...', options: [{ text: "after the shopping.", translation: "åœ¨è³¼ç‰©ä¹‹å¾Œ" }, { text: "before school.", translation: "åœ¨ä¸Šå­¸å‰" }] }
          ]
        },
        {
          id: 's4',
          label: 'ç¬¬å››å¥ï¼šç¸½çµ (Conclusion)',
          subLabel: 'ç¸½çµå¥æ§‹ï¼šå€‹äººè§€é»',
          parts: [
             { type: 'é–‹é ­', grammarRole: 'Opener', question: 'æˆ‘èªç‚º...', options: [{ text: "I think", translation: "æˆ‘èªç‚º" }, { text: "I suspect", translation: "æˆ‘æ‡·ç–‘" }] },
             { type: 'ä¸»é¡Œ', grammarRole: 'Topic', question: 'ä»€éº¼æ˜¯æœ€æ£’çš„ï¼Ÿ', options: [{ text: "family time", translation: "å®¶åº­æ™‚å…‰" }, { text: "shopping alone", translation: "ç¨è‡ªè³¼ç‰©" }] },
             { type: 'çµè«–', grammarRole: 'Conclusion', question: 'æ˜¯ä»€éº¼ï¼Ÿ', options: [{ text: "is the best time.", translation: "æ˜¯æœ€æ£’çš„æ™‚å…‰" }, { text: "is expensive.", translation: "å¾ˆæ˜‚è²´" }] }
          ]
        }
      ]
    }
  };

  // ğŸŒŸ ä¿®æ”¹ï¼šæ¥æ”¶æ•´å€‹ option ç‰©ä»¶
  const handleOptionSelect = (option) => {
    if (isProcessing) return;
    setIsProcessing(true);

    // 1. æ›´æ–°è‹±æ–‡éƒ¨åˆ†
    const newParts = [...currentSentenceParts, option.text];
    setCurrentSentenceParts(newParts);
    
    // 2. æ›´æ–°ä¸­æ–‡éƒ¨åˆ†
    const newTranslations = [...currentSentenceTranslations, option.translation];
    setCurrentSentenceTranslations(newTranslations);

    const currentScenario = scenarios[activeScenarioId];
    const sentenceConfig = currentScenario.sentences[currentSentenceIndex];

    if (currentPartIndex < sentenceConfig.parts.length - 1) {
      setCurrentPartIndex(prev => prev + 1);
      setTimeout(() => setIsProcessing(false), 300);
    } else {
      setTimeout(() => {
        setMode('review'); 
        setIsProcessing(false);
      }, 500);
    }
  };

  // ğŸŒŸ ä¿®æ”¹ï¼šUndo æ™‚åŒæ™‚é€€å›ä¸­è‹±æ–‡
  const handleUndo = () => {
    if (isProcessing) return;

    if (currentPartIndex > 0) {
      // é€€å›ä¸Šä¸€å€‹ Part
      const newParts = currentSentenceParts.slice(0, -1);
      setCurrentSentenceParts(newParts);
      
      const newTrans = currentSentenceTranslations.slice(0, -1);
      setCurrentSentenceTranslations(newTrans);
      
      setCurrentPartIndex(prev => prev - 1);
      setMode('building');
    } 
    else if (currentSentenceIndex > 0) {
      // é€€å›ä¸Šä¸€å¥
      const prevSentenceIndex = currentSentenceIndex - 1;
      setCurrentSentenceIndex(prevSentenceIndex);
      
      // å¾æ­·å²ç´€éŒ„ç§»é™¤æœ€å¾Œä¸€å¥
      const newHistory = fullSpeechHistory.slice(0, -1);
      setFullSpeechHistory(newHistory);
      
      // æ¸…ç©ºç•¶å‰æš«å­˜
      setCurrentSentenceParts([]); 
      setCurrentSentenceTranslations([]); 
      setCurrentPartIndex(0); 
      setMode('building');
    }
  };

  // ğŸŒŸ ä¿®æ”¹ï¼šNext Sentence æ™‚çµ„åˆä¸­è‹±æ–‡ä¸¦å­˜å…¥æ­·å²
  const handleNextSentence = () => {
    const completedEnglish = currentSentenceParts.join(" ");
    const completedChinese = currentSentenceTranslations.join(""); // ä¸­æ–‡ä¸åŠ ç©ºæ ¼

    const newHistoryItem = { english: completedEnglish, chinese: completedChinese };
    const newHistory = [...fullSpeechHistory, newHistoryItem];
    setFullSpeechHistory(newHistory);

    const currentScenario = scenarios[activeScenarioId];
    if (currentSentenceIndex < currentScenario.sentences.length - 1) {
      setCurrentSentenceIndex(prev => prev + 1);
      setCurrentPartIndex(0);
      setCurrentSentenceParts([]);
      setCurrentSentenceTranslations([]);
      setMode('building');
    } else {
      setMode('finished');
    }
  };

  const resetAll = () => {
    setActiveScenarioId(null);
    setShowTips(false);
    setMode('building');
    setCurrentSentenceIndex(0);
    setCurrentPartIndex(0);
    setCurrentSentenceParts([]);
    setCurrentSentenceTranslations([]);
    setFullSpeechHistory([]);
    setIsProcessing(false);
  };

  if (showTutorial) {
    return <TutorialView onFinish={() => setShowTutorial(false)} />;
  }

  if (!activeScenarioId) {
    return (
      <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center space-y-8 animate-fade-in">
        <div className="text-center space-y-2">
          <h1 className="text-3xl font-bold text-slate-800">å–®å¥å°ˆæ³¨é€ å¥æ³•</h1>
          <p className="text-slate-500">é€éã€Œå¥å‹è—åœ–ã€ï¼Œå­¸æœƒè‹±æ–‡å¥å­çš„é‚è¼¯ã€‚</p>
        </div>

        <div className="w-full max-w-2xl bg-indigo-600 rounded-2xl p-6 text-white shadow-lg flex flex-col md:flex-row items-center justify-between gap-6 hover:shadow-xl transition-shadow cursor-pointer group" onClick={() => setShowTutorial(true)}>
          <div className="flex items-center gap-4">
            <div className="p-3 bg-white/20 rounded-xl group-hover:bg-white/30 transition-colors">
               <BookOpen className="w-8 h-8" />
            </div>
            <div className="text-left">
              <h2 className="text-xl font-bold">èª²å‰å°è®€ï¼šè‹±æ–‡é€ å¥çš„é»ƒé‡‘é †åº</h2>
              <p className="text-indigo-100 text-sm mt-1">ç´„ 20 åˆ†é˜ | é©åˆåˆå­¸è€…å»ºç«‹è§€å¿µ</p>
            </div>
          </div>
          <button 
            className="px-6 py-2 bg-white text-indigo-600 rounded-full font-bold hover:bg-indigo-50 transition-colors whitespace-nowrap flex items-center gap-2"
          >
            <Play className="w-4 h-4 fill-current" /> é–‹å§‹ä¸Šèª²
          </button>
        </div>

        <div className="w-full max-w-2xl">
          <h3 className="text-slate-400 font-bold text-sm uppercase tracking-wider mb-4 text-center">é¸æ“‡ç·´ç¿’æƒ…å¢ƒ</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {Object.values(scenarios).map(s => (
              <button
                key={s.id}
                onClick={() => {
                  setActiveScenarioId(s.id);
                  setShowTips(true);
                }}
                className={`flex flex-col items-center p-8 bg-white rounded-2xl border-2 border-transparent hover:border-${s.color}-400 hover:shadow-lg transition-all group`}
              >
                <div className={`p-4 rounded-full bg-${s.color}-50 text-${s.color}-600 mb-4 group-hover:scale-110 transition-transform`}>
                  {s.icon}
                </div>
                <h3 className="text-xl font-bold text-slate-700">{s.title}</h3>
                <span className="text-sm text-slate-400 mt-2 flex items-center gap-1 group-hover:text-${s.color}-500">
                   é»æ“Šé–‹å§‹ <ArrowRight className="w-3 h-3" />
                </span>
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (showTips) {
    return <TipsView onNext={() => setShowTips(false)} />;
  }

  // ğŸŒŸ ä¿®æ”¹ï¼šå®Œæˆé é¢é¡¯ç¤ºä¸­è‹±æ–‡
  if (mode === 'finished') {
    return (
      <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center animate-fade-in">
        <div className="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8 space-y-8 text-center">
          <div className="inline-flex p-4 rounded-full bg-green-100 text-green-600 mb-2">
            <CheckCircle className="w-10 h-10" />
          </div>
          <div>
            <h2 className="text-3xl font-bold text-slate-800 mb-2">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p className="text-slate-500">é€™æ˜¯ä½ ä¾ç…§å¥å‹é‚è¼¯çµ„å‡ºçš„å®Œæ•´è¬›ç¨¿ï¼š</p>
          </div>
          
          <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 text-left space-y-6">
             {fullSpeechHistory.map((item, idx) => (
               <div key={idx} className="border-b border-slate-100 pb-4 last:border-0 last:pb-0">
                 <p className="text-lg text-slate-700 leading-relaxed font-medium">
                   <span className="font-bold text-slate-300 mr-2">{idx + 1}.</span> {item.english}
                 </p>
                 <p className="text-slate-500 text-sm mt-1 pl-8">
                   {item.chinese}
                 </p>
               </div>
             ))}
          </div>

          <button onClick={resetAll} className="px-8 py-3 bg-slate-800 text-white rounded-full hover:bg-slate-700 transition-colors flex items-center gap-2 mx-auto font-bold shadow-lg hover:shadow-xl">
            <RefreshCw className="w-4 h-4" /> å†ç·´ç¿’ä¸€æ¬¡
          </button>
        </div>
      </div>
    );
  }

  const currentScenario = scenarios[activeScenarioId];
  const sentenceConfig = currentScenario.sentences[currentSentenceIndex];
  const currentPart = sentenceConfig.parts[currentPartIndex];
  const canUndo = currentPartIndex > 0 || currentSentenceIndex > 0;

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">
      <div className="bg-white px-4 py-3 shadow-sm border-b border-slate-200 sticky top-0 z-10">
        <div className="max-w-3xl mx-auto flex justify-between items-center">
          <button onClick={resetAll} className="text-slate-400 hover:text-slate-600 font-bold text-sm">âœ• é€€å‡º</button>
          <span className="text-slate-500 font-bold text-sm">Step {currentSentenceIndex + 1}</span>
        </div>
      </div>

      <div className="flex-1 max-w-3xl mx-auto w-full p-4 lg:p-6 flex flex-col space-y-6 pb-20">
        
        {/* åœ–ç‰‡æƒ…å¢ƒå€ */}
        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex gap-4 items-start animate-fade-in">
           <div className={`p-3 rounded-lg bg-${currentScenario.color}-50 text-${currentScenario.color}-600 shrink-0 hidden sm:block`}>
             <ImageIcon className="w-6 h-6" />
           </div>
           <div>
             <h3 className="font-bold text-slate-700 mb-1 flex items-center gap-2">
               <span className="sm:hidden text-indigo-500"><ImageIcon className="w-4 h-4"/></span> 
               åœ–ç‰‡æƒ…å¢ƒ
             </h3>
             <p className="text-slate-600 text-sm leading-relaxed">
               {currentScenario.description}
             </p>
           </div>
        </div>

        {/* ğŸŒŸ ä¿®æ”¹ï¼šæ­·å²ç´€éŒ„é¡¯ç¤ºä¸­è‹±æ–‡ */}
        {fullSpeechHistory.length > 0 && (
          <div className="bg-slate-100 rounded-xl p-5 border border-slate-200 animate-slide-up">
            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
              <BookOpen className="w-3 h-3" /> ä½ çš„æ¼”è¬›ç¨¿ç´¯ç©ä¸­...
            </h3>
            <div className="space-y-3">
              {fullSpeechHistory.map((item, idx) => (
                <div key={idx} className="flex gap-2 text-slate-600 animate-fade-in items-start">
                  <span className="font-bold text-slate-300 select-none mt-0.5">{idx + 1}.</span>
                  <div>
                     <p className="font-medium">{item.english}</p>
                     <p className="text-xs text-slate-400 mt-0.5">{item.chinese}</p>
                  </div>
                </div>
              ))}
              <div ref={historyEndRef} />
            </div>
          </div>
        )}

        <hr className="border-slate-100" />
        
        <StoryFlow currentStep={currentSentenceIndex} />

        {/* äº’å‹•é€ å¥å€ */}
        <div className="space-y-6">
          <div className="text-center space-y-1 animate-slide-up">
            <h2 className="text-xl font-bold text-slate-800">{sentenceConfig.label}</h2>
            <p className="text-slate-500 text-sm flex items-center justify-center gap-1">
              <Lightbulb className="w-3 h-3 text-amber-500" />
              {sentenceConfig.subLabel}
            </p>
          </div>

          <div className="flex flex-wrap items-center justify-center gap-2 lg:gap-4 mb-4 select-none">
            {sentenceConfig.parts.map((part, idx) => {
              const isActive = idx === currentPartIndex && mode === 'building';
              const isDone = idx < currentPartIndex || mode === 'review';
              
              return (
                <div key={idx} className="flex items-center gap-2">
                  <div className={`
                    px-3 py-1.5 rounded-lg text-xs font-bold border transition-all flex items-center gap-1.5
                    ${isActive 
                      ? 'bg-indigo-600 text-white border-indigo-600 shadow-md scale-105' 
                      : isDone 
                        ? 'bg-green-50 text-green-700 border-green-200' 
                        : 'bg-white text-slate-300 border-slate-200'
                    }
                  `}>
                    {isDone ? <CheckCircle className="w-3 h-3" /> : <span className="w-3 h-3 flex items-center justify-center rounded-full bg-current opacity-20 text-[8px]">{idx + 1}</span>}
                    {part.type}
                  </div>
                  {idx < sentenceConfig.parts.length - 1 && (
                    <ArrowRight className={`w-3 h-3 ${isDone ? 'text-green-300' : 'text-slate-200'}`} />
                  )}
                </div>
              );
            })}
          </div>

          <div className={`rounded-2xl p-6 lg:p-8 shadow-sm border min-h-[120px] flex flex-wrap items-center justify-center content-center gap-2 text-lg lg:text-xl transition-all relative overflow-hidden
            ${mode === 'review' ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200'}
          `}>
            {mode === 'review' && (
              <div className="absolute top-0 right-0 bg-green-100 text-green-600 px-3 py-1 rounded-bl-xl font-bold text-xs flex items-center gap-1 animate-fade-in">
                <CheckCircle className="w-3 h-3" /> å®Œæˆ
              </div>
            )}

            {currentSentenceParts.length === 0 && (
              <span className="text-slate-300 italic">æº–å‚™é–‹å§‹...</span>
            )}

            {currentSentenceParts.map((text, i) => (
              <span key={i} className="animate-fade-in font-medium text-slate-800">
                {text}
              </span>
            ))}

            {mode === 'building' && (
              <span className="w-2 h-6 bg-indigo-500 animate-pulse rounded-full ml-1"></span>
            )}
          </div>

          <div className="flex justify-between items-center h-6">
             <div className="flex items-center gap-2">
               <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">
                 {mode === 'building' ? 'ç¾åœ¨è«‹é¸æ“‡ï¼š' : 'ç¢ºèªèˆ‡ä¸‹ä¸€æ­¥ï¼š'}
               </span>
               {mode === 'building' && (
                  <span className="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">
                    {currentPart.grammarRole}
                  </span>
               )}
             </div>
             
             <button 
              onClick={handleUndo}
              disabled={!canUndo || isProcessing}
              className={`flex items-center gap-1 text-sm px-3 py-1 rounded-full transition-colors
                ${canUndo 
                  ? 'text-slate-500 hover:bg-slate-200 hover:text-slate-700' 
                  : 'text-slate-300 cursor-not-allowed'}
              `}
            >
              <Undo2 className="w-4 h-4" /> 
              {currentPartIndex === 0 && currentSentenceIndex > 0 ? "å›ä¸Šä¸€å¥" : "ä¸Šä¸€æ­¥"}
            </button>
          </div>

          {mode === 'building' ? (
            <div className="space-y-2 animate-slide-up-delay">
               <p className="text-sm font-medium text-slate-700 mb-2 pl-1 flex items-center gap-2">
                 <Layers className="w-4 h-4 text-slate-400" />
                 {currentPart.question}
               </p>
               <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {currentPart.options.map((option, idx) => (
                  <button
                    key={idx}
                    disabled={isProcessing}
                    // ğŸŒŸ ä¿®æ”¹ï¼šå‚³éæ•´å€‹ option ç‰©ä»¶
                    onClick={() => handleOptionSelect(option)}
                    className={`group text-left p-4 bg-white rounded-xl border transition-all active:scale-[0.98]
                      ${isProcessing ? 'opacity-50 cursor-wait border-slate-100' : 'border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer'}
                    `}
                  >
                    <div className="flex flex-col gap-1">
                      <span className="font-bold text-base text-slate-700 group-hover:text-indigo-600">
                        {option.text}
                      </span>
                      <span className="text-xs text-slate-400 group-hover:text-slate-500">
                        {option.translation}
                      </span>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          ) : (
            <div className="animate-fade-in">
               <button 
                 onClick={handleNextSentence}
                 className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 transition-colors shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
               >
                 é€²å…¥ä¸‹ä¸€å¥ <ArrowRight className="w-5 h-5" />
               </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default OneSentenceApp;
